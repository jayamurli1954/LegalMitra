<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cost Dashboard - LegalMitra</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Track AI API costs and savings">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" href="/icons/icon-192x192.png">

    <style>
        * {margin: 0; padding: 0; box-sizing: border-box;}
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .header h1 {color: #667eea;}
        .back-btn {
            background: #e0e0e0;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            color: #333;
        }
        .period-selector {
            margin-bottom: 25px;
            display: flex;
            gap: 10px;
        }
        .period-btn {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
        }
        .period-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stat-card.highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .stat-label {font-size: 0.9em; opacity: 0.8; margin-bottom: 5px;}
        .stat-value {font-size: 2em; font-weight: bold;}
        .stat-subtext {font-size: 0.85em; margin-top: 5px; opacity: 0.9;}
        .savings-card {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        .savings-card h2 {margin-bottom: 10px;}
        .savings-amount {font-size: 2.5em; font-weight: bold; margin: 10px 0;}
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            margin-bottom: 25px;
        }
        .chart-container h3 {color: #667eea; margin-bottom: 15px;}
        table {width: 100%; border-collapse: collapse;}
        th, td {padding: 12px; text-align: left; border-bottom: 1px solid #e0e0e0;}
        th {background: #f5f5f5; font-weight: bold;}
        .loading {text-align: center; padding: 50px;}
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% {transform: rotate(0deg);}
            100% {transform: rotate(360deg);}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Cost Tracking Dashboard</h1>
            <a href="index.html" class="back-btn">‚Üê Back</a>
        </div>

        <div class="period-selector">
            <button class="period-btn" onclick="loadDashboard(7, this)">Last 7 Days</button>
            <button class="period-btn active" onclick="loadDashboard(30, this)">Last 30 Days</button>
            <button class="period-btn" onclick="loadDashboard(90, this)">Last 90 Days</button>
        </div>

        <div id="dashboard-content">
            <div class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 10px;">Loading dashboard...</p>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        let currentPeriod = 30;

        async function loadDashboard(days = 30, eventTarget = null) {
            currentPeriod = days;
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));

            // Only try to add active class if eventTarget is provided (button click)
            if (eventTarget) {
                eventTarget.classList.add('active');
            } else {
                // On page load, activate the correct button
                document.querySelectorAll('.period-btn').forEach(btn => {
                    if (btn.textContent.includes('30')) {
                        btn.classList.add('active');
                    }
                });
            }

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/cost-tracking/dashboard?days=${days}`);
                const data = await response.json();

                console.log('Dashboard data received:', data); // Debug log

                // Check if there's no data
                if (!data || !data.summary || data.summary.total_queries === 0) {
                    showNoDataMessage();
                    return;
                }

                renderDashboard(data);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('dashboard-content').innerHTML = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 15px; text-align: center; margin: 20px 0;">
                        <h2 style="margin-bottom: 20px;">‚ö†Ô∏è Unable to Load Dashboard</h2>
                        <p style="font-size: 1.1em; margin-bottom: 15px;">Make sure the backend server is running.</p>
                        <p style="opacity: 0.9;">Backend should be running at: http://localhost:8888</p>
                    </div>
                `;
            }
        }

        function showNoDataMessage() {
            document.getElementById('dashboard-content').innerHTML = `
                <div style="background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); color: white; padding: 50px; border-radius: 15px; text-align: center; margin: 20px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                    <h2 style="font-size: 2.5em; margin-bottom: 20px;">üìä No Usage Data Yet</h2>
                    <p style="font-size: 1.3em; margin-bottom: 30px; line-height: 1.6;">
                        You haven't made any queries yet!<br>
                        Start using LegalMitra to see your cost analytics here.
                    </p>

                    <div style="background: rgba(255,255,255,0.2); padding: 25px; border-radius: 10px; margin: 25px 0;">
                        <h3 style="margin-bottom: 15px; font-size: 1.5em;">‚ú® Get Started:</h3>
                        <ol style="text-align: left; max-width: 500px; margin: 0 auto; font-size: 1.1em; line-height: 2;">
                            <li>Go to <strong>Legal Research</strong> tab</li>
                            <li>Ask any legal question</li>
                            <li>Submit your query</li>
                            <li>Come back here to see costs!</li>
                        </ol>
                    </div>

                    <button onclick="window.location.href='index.html'" style="background: white; color: #56ab2f; padding: 15px 40px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.2em; margin-top: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        üöÄ Go to Legal Research
                    </button>

                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid rgba(255,255,255,0.3);">
                        <p style="font-size: 1em; opacity: 0.9;">
                            üí° <strong>Tip:</strong> Try asking "What is Section 9 of CGST Act?" as your first query!
                        </p>
                    </div>
                </div>
            `;
        }

        function renderDashboard(data) {
            const html = `
                <!-- Savings vs VIDUR -->
                <div class="savings-card">
                    <h2>üí∞ Your Savings vs VIDUR</h2>
                    <div class="savings-amount">$${data.vidur_comparison.savings.average_usd}/month</div>
                    <p>${data.vidur_comparison.message}</p>
                    <p style="margin-top: 10px; opacity: 0.9;">
                        LegalMitra: $${data.vidur_comparison.legalmitra_monthly_cost}/month |
                        VIDUR: $${data.vidur_comparison.vidur_estimated_cost.average}/month
                    </p>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card highlight">
                        <div class="stat-label">Total Cost</div>
                        <div class="stat-value">$${data.summary.total_cost_usd}</div>
                        <div class="stat-subtext">Last ${currentPeriod} days</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Queries</div>
                        <div class="stat-value">${data.summary.total_queries}</div>
                        <div class="stat-subtext">${data.summary.total_tokens.toLocaleString()} tokens</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg Cost/Query</div>
                        <div class="stat-value">$${data.summary.average_cost_per_query}</div>
                        <div class="stat-subtext">${data.summary.average_tokens_per_query} tokens avg</div>
                    </div>
                </div>

                <!-- Cost by Model -->
                <div class="chart-container">
                    <h3>Cost Breakdown by AI Model</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th>Queries</th>
                                <th>Tokens</th>
                                <th>Total Cost</th>
                                <th>Avg Cost/Query</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.by_model.map(m => `
                                <tr>
                                    <td>${m.model_name}</td>
                                    <td>${m.queries}</td>
                                    <td>${m.total_tokens.toLocaleString()}</td>
                                    <td>$${m.total_cost_usd}</td>
                                    <td>$${m.avg_cost_per_query}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                <!-- Cost by Query Type -->
                <div class="chart-container">
                    <h3>Cost Breakdown by Query Type</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Query Type</th>
                                <th>Queries</th>
                                <th>Total Cost</th>
                                <th>Avg Cost/Query</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.by_query_type.map(q => `
                                <tr>
                                    <td>${q.query_type}</td>
                                    <td>${q.queries}</td>
                                    <td>$${q.total_cost_usd}</td>
                                    <td>$${q.avg_cost_per_query}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                <!-- Daily Trend -->
                <div class="chart-container">
                    <h3>Daily Cost Trend</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Queries</th>
                                <th>Tokens</th>
                                <th>Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.daily_trend.slice(-14).map(d => `
                                <tr>
                                    <td>${d.date}</td>
                                    <td>${d.queries}</td>
                                    <td>${d.tokens.toLocaleString()}</td>
                                    <td>$${d.cost_usd}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('dashboard-content').innerHTML = html;
        }

        // Load on page ready
        loadDashboard(30);
    </script>
</body>
</html>
